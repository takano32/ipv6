===================================
5分でわかるIPv6
===================================

- タイトルを中央にもってくる方法がわからない

  - ってか、書いてる間にプレゼンツールがデグレしたっぽい

- CA x GREE 合同勉強会

  - 2011-07-27 於 グリー株式会社

----

お前、誰よ
----------

@takano32 a.k.a. 高野光弘

- グリー株式会社 開発本部 インフラ統括部

  - サーバの状態を指揮するようなツールとか作ってます

- 日本UNIXユーザ会

  - 理事 / 幹事のなかでは最年少のはずなんだけど・・・

  - 同年代から「暗黒UNIXおじさん」と呼ばれる

    - ようするにバッドノウハウのプロっぽい ... orz

- Rubyコミッタ

  - IA-64という世にも奇妙なアーキのメンテナ

    - IA-64やAMD64やIntel64を対象にした仮想計算機機構を作ってた

    - IA-64でFiber#resumeが落ちるのはぼくのせいです

----

今日のアジェンダ
----------------
IPv6の暗黒面とかの話をします

- ネットワーク屋の常識とソフトウェア屋の常識

  - 剥離がおそろしい

  - いまIPv4でできてることができなくなるよ

  - ソフトウェアエンジニアが「ギャー」ってなる例とか紹介します

- 5分でIPv6の仔細を理解できたらすごすぎ

  - IPv6の仕様については最低限しか触れません

----

復習: インターネットの恐ろしさ
------------------------------

IPv6の前にIPv4もコワイですよ

ex. 127.0.0.1 / ループバックアドレス

- 自身のIPアドレスであるらしい

  - 「みんなそう指定してるから指定してる」でしょ？

- 由来は慣習的

  - ループバックさせている実現方法はさまざま

- 現在では 127.0.0.0/8 という説が有力

  - つまり、 127.x.y.z でよいという説が有力

----

Linux 2.6.27.39 ia64 GNU/Linux
------------------------------

::

  takano32% uname -srmo
  Linux 2.6.27.39 ia64 GNU/Linux
  takano32% ping -c 3 127.16.32.64
  PING 127.16.32.64 (127.16.32.64) 56(84) bytes of data.
  64 bytes from 127.16.32.64: icmp_req=1 ttl=64 time=0.038 ms
  64 bytes from 127.16.32.64: icmp_req=2 ttl=64 time=0.009 ms
  64 bytes from 127.16.32.64: icmp_req=3 ttl=64 time=0.008 ms
  
  --- 127.16.32.64 ping statistics ---
  3 packets transmitted, 3 received, 0% packet loss, time 2013ms
  rtt min/avg/max/mdev = 0.008/0.018/0.038/0.014 ms

- 有力な説の 127.0.0.0/8 を採用

----

Darwin 10.8.0 x86_64 Darwin
---------------------------

::

  takano32% uname -srmo
  Darwin 10.8.0 x86_64 Darwin
  takano32% ping -c 3 127.16.32.64
  PING 127.16.32.64 (127.16.32.64): 56 data bytes
  Request timeout for icmp_seq 0
  Request timeout for icmp_seq 1
  
  --- 127.16.32.64 ping statistics ---
  3 packets transmitted, 0 packets received, 100.0% packet loss

- 100.0% packet loss...

  - /etc/hosts に書いてあるので分かりやすい

- インターネットはカオス

  - よくわかんないのになんか動いてる部分たくさん

  - 日頃使ってるものさえもよくわからない

- さらに **よくわかんないIPv6** というものがやってくる

  - IPv6 では ::1 がループバックアドレスと明示されてるけどね

----

アドレス表記
------------

ex. IPv6のリンクローカルアドレス

- よくわかんないが勝手に 169.254.0.0/16 とか割り当てるやつの正式名称

- IPv6ではIPv4のプライベートアドレスのように使ったりする

   - 元々の意味はブロードキャストセグメントの通信に使えるアドレス

----

アドレス表記 (Contd.)
---------------------

- IPv4 プライベートアドレス

  - 10.0.0.0/8 or 172.16.0.0/12 or 192.168.0.0/16

- IPv6 リンクローカルアドレス

  - fe80::/10

  - 続きはRFC 1884で

- みなさん、 http://192.168.32.16/ とかアクセスしますよね

  - IPv6ではどう書くんでしょうか

----

アドレス表記 (Contd.)
---------------------

正解とポイント

- http://[fe80::01%en0]:8080/

  - コロン区切り表記に由来してポート番号がわからなくなるので [] が必要

  - インターフェイスを指定しないとIPv6では行き先がわかんなくなる

  - これも続きはRFC 1884で

- ネットワーク屋の主張

  - AAAA で引けばアドレス打たなくていい

  - データの裏付けも取れてる

    - ex. World IPv6 Day

でも、それはユーザの視点。開発者はヤバイ。

192.168.32.16 使えないと困るよね。

----

実際にIPv6を使ってみた
----------------------

::

  takano32% wget -O - 'http://[fe80::1%en0]:7890/'
  http://[fe80::1%en0]:7890/: IPv6 アドレスが不正です.

- -6 してみた

  - 明示的なIPv6の利用のオプション

::

  takano32% w3m -6 -dump 'http://[fe80::1%en0]:7890/'
  w3m: Can't load http://[fe80::1%en0]:7890/.

- ちょっとがんばった！でも、ムリ！！！

'RFC 4007 11.2.  The <zone_id> Part' など **ガン無視**

----

User Agentのまとめ
------------------

================ ====================================
User Agent       IPv6 linklocal address Ready?
================ ====================================
Opera  11.50     NG
Chrome dev       NG
Chrome canary    NG
Firefox 5.0.1    OK!
wget             NG
w3m              NG
Lynx             OK!
================ ====================================

- Firefoxがんばってる

  - 探すと Host: ヘッダーに関する議論もフォーラムでしてる

- Chr*meェ・・・

  - IPv6にしても困らないって声を大にして言ってるところのブラウザ

  - 困るやんけ・・・

- 意外だったのは w3m vs. Lynx

  - w3m のほうがユーザ数多い気がする

  - メンテナも多い気がする

----

アドレスが不正 2.0
------------------

.. image:: opera.png

アドレスのパース部分なのでネットワーク屋が得意なプロトコルスタックを改修してもムダ。

アプリケーションの対応が必要。 レイヤーが複雑なWebアプリケーションは悲惨。

----

ex. 処理系
----------

ex. みんな大好き PHP

::

  takano32% php -v
  PHP 5.3.6 (cli) (built: Jun  3 2011 16:17:53) (DEBUG)
  Copyright (c) 1997-2011 The PHP Group
  Zend Engine v2.3.0, Copyright (c) 1998-2011 Zend Technologies

::

  takano32% php -r 'var_dump(parse_url("http://[fe80::1%en0]:7890/"));'
  array(4) {
    ["scheme"]=>
    string(4) "http"
    ["host"]=>
    string(13) "[fe80::1%en0]"
    ["port"]=>
    int(7890)
    ["path"]=>
    string(1) "/"
  }

- ソース読んでないけど、これは実装が適当すぎる例ですね

  - host は [] が取り除かれないと他の用途で使うときはダメ

- Rubyはちょっとだけ、ほんとにちょっとだけマシ？

  - URI::InvalidURIError という例外が発生する

----

ex. フレームワーク
------------------

ex. Sinatra / sinatra / lib / sinatra / base.rb

  https://github.com/sinatra/sinatra/blob/master/lib/sinatra/base.rb

:: 

  takano32% LANG=C date
  Mon Jul 25 18:31:05 JST 2011

たぶん今も同じコード

.. code-block:: ruby

    set :run, false                       # start server via at-exit hook?
    set :running, false                   # is the built-in server running now?
    set :server, %w[thin mongrel webrick]
    set :bind, '0.0.0.0'
    set :port, 4567

えっ・・・ちょっとなんかすごいのがチラついた・・・

.. code-block:: ruby

    set :bind, '0.0.0.0'

- IPv6というものは **アウト・オブ・眼中** という例

  - IPv4の10進数表記をやめて、 set :bind, nil で対応できる

  - っていうか、放置してればIPv6でも使えるのに余計なことしてる・・・

----

FAQ
---

- なんでチケット切らないんですか

  - 影響プロダクトが無数

  - @takano32 はクラウドのようにスケールしない

  - できるのは啓蒙活動くらい

  - Rubyまわりくらいはなおしてもいいかもしれない

    - CRubyは処理系のコミット権もってるので折衝不要だし

----

まとめ
------

- **どのレイヤーで問題が起こるかわからない** ので、必要なときには専門外のソースコードにもダイブする勇気を

- 同じ問題意識を共有し、世界のサービスが「ギャー」ってならないようにがんばろう

- そして、余裕があれば啓蒙活動をしましょう

- 今回の例は氷山の一角で広く使われはじめたら何が起こるか分かりません

----

おしまい
--------

- ご清聴ありがとうございました

- 宣伝

  - LL Planets / IPv6ハッカソン で登壇します

  - http://ll.jus.or.jp/2011/program/ipv6hackathon.html

    - てか、LL Planets実行委員もやってて、絶賛登壇者募集中

    - ぼくと契約してIPv6ハッカソンに出場し(ry

  - チケット買っていただけると実行委員一同歓喜

    - 最速ほげふが研究会のマラもくるのでたぶん楽しい

----

おまけ：あなたの IPv6 レベル
----------------------------

独断と偏見

#. "IPv6"という文字列
#. IPv4 と IPv6 の存在
#. IPv4 のIPアドレスが少ない
#. IPv4 のグローバルアドレスが枯渇した
#. IPv4 のアドレスは32ビットで IPv6 のアドレスは 128ビット
#. IPv4 と IPv6 のヘッダの違い
#. IPv6 のアドレス表記
#. AAAA レコードの存在

